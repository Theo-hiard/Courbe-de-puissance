<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Courbes de puissance</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <header
      style="
        width: 100%;
        text-align: center;
        padding: 40px 0 20px;
        background: linear-gradient(to right, #3b82f6, #60a5fa);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      "
    >
      <h1 style="font-size: 2.5em; font-weight: 700; color: white; margin: 0">
        Courbe de puissance Assetto Corsa
      </h1>
      <p style="margin-top: 8px; color: #e0f2fe; font-size: 1em">
        Visualisation et ajustement en temps réel
      </p>
    </header>
    <div id="main-container">
      <div id="table-container"></div>
      <div id="chart-container">
        <canvas id="Courbes"></canvas>
        <div>
          <button id="reset-button" onclick="resetValues()">
            Réinitialiser
          </button>
          <button id="smooth-button" onclick="smoothCurve()">
            Lisser la courbe
          </button>
        </div>
      </div>

      <div id="sliders-container">
        <div style="margin-bottom: 20px">
          <label for="rpm-search" style="font-weight: bold; font-size: 0.95em"
            >Aller au régime (tr/min) :</label
          >
          <input
            type="number"
            id="rpm-search"
            placeholder="Ex: 4500"
            style="
              width: 100%;
              padding: 6px 10px;
              margin-top: 5px;
              border: 1px solid #ccc;
              border-radius: 6px;
              font-size: 1em;
            "
            oninput="scrollToSlider(this.value)"
          />
        </div>

        <div id="sliders"></div>
      </div>
    </div>
    <footer
      style="
        width: 100%;
        text-align: center;
        padding: 16px 0;
        background-color: #f1f5f9;
        color: #64748b;
        font-size: 0.95em;
        border-top: 1px solid #e2e8f0;
        margin-top: 40px;
      "
    >
      <span style="font-weight: 500">Made with ❤️ by Théo H</span>
    </footer>
    <script>
      let labels = [];
      for (let i = 0; i <= 7200; i += 300) {
        labels.push(i);
      }

      function generateGT2RSValues() {
        return labels
          .map((rpm) => {
            if (rpm < 2500) return 150;
            if (rpm < 4000) return 300 + (rpm - 2500) * 0.28; // montée rapide
            if (rpm <= 6700) return 700;
            if (rpm > 6700) return Math.max(0, 700 - (rpm - 6700) * 0.4); // chute rapide
            return 0;
          })
          .map((v) => Math.round(v));
      }

      let values = generateGT2RSValues();
      let valuesKW = values.map((v) => +(v * 0.7355).toFixed(1));

      function createSliders(filter = null) {
        let slidersDiv = document.getElementById("sliders");
        slidersDiv.innerHTML = "";

        for (let i = 0; i < labels.length; i++) {
          const rpmStr = labels[i].toString();
          if (filter !== null && !rpmStr.includes(filter.toString())) continue;

          slidersDiv.innerHTML += `
      <div class="slider-group">
        <label for="slider${i}">Régime = ${labels[i]} tr/min</label>
        <input type="range" min="0" max="1200" value="${values[i]}" id="slider${i}" oninput="updateValue(${i}, this.value, true)">
        <input type="number" min="0" max="1200" value="${values[i]}" id="number${i}" oninput="updateValue(${i}, this.value, false)">
      </div>
    `;
        }

        if (filter !== null && slidersDiv.innerHTML === "") {
          slidersDiv.innerHTML = `<div style="padding: 10px; color: #ef4444; text-align: center;">Aucun slider ne correspond à "${filter}"</div>`;
        }
      }

      function updateValue(index, val, fromSlider) {
        val = Math.max(0, Math.min(1200, Number(val)));
        values[index] = Math.round(val);
        valuesKW[index] = +(val * 0.7355).toFixed(1);
        document.getElementById("slider" + index).value = values[index];
        document.getElementById("number" + index).value = values[index];

        Courbes.data.datasets[0].data = values;
        Courbes.data.datasets[1].data = valuesKW;
        Courbes.options.scales.y.suggestedMax = Math.max(...values) * 1.1;
        Courbes.options.scales.y1.max =
          Courbes.options.scales.y.suggestedMax * 0.7355;
        Courbes.update();
        createTable();
      }

      function resetValues() {
        values = generateGT2RSValues();
        valuesKW = values.map((v) => +(v * 0.7355).toFixed(1));
        createSliders();
        Courbes.data.datasets[0].data = values;
        Courbes.data.datasets[1].data = valuesKW;
        Courbes.options.scales.y.suggestedMax = Math.max(...values) * 1.1;
        Courbes.options.scales.y1.max =
          Courbes.options.scales.y.suggestedMax * 0.7355;
        Courbes.update();
        createTable();
      }

      function smoothCurve() {
        let smoothed = [...values];
        for (let i = 1; i < values.length - 1; i++) {
          smoothed[i] = Math.round(
            (values[i - 1] + values[i] + values[i + 1]) / 3
          );
        }
        values = smoothed;
        valuesKW = values.map((v) => +(v * 0.7355).toFixed(1));
        for (let i = 0; i < values.length; i++) {
          document.getElementById("slider" + i).value = values[i];
          document.getElementById("number" + i).value = values[i];
        }
        Courbes.data.datasets[0].data = values;
        Courbes.data.datasets[1].data = valuesKW;
        Courbes.options.scales.y.suggestedMax = Math.max(...values) * 1.1;
        Courbes.options.scales.y1.max =
          Courbes.options.scales.y.suggestedMax * 0.7355;
        Courbes.update();
        createTable();
      }

      function createTable() {
        let tableHTML = `
    <div style="text-align: center; margin-bottom: 10px;">
      <button id="copy-table-button" onclick="copyTable()">Copier les données</button>
    </div>
    <table>
      <tr><th>Régime (tr/min)</th><th>Puissance (kW)</th></tr>
  `;
        for (let i = 0; i < labels.length; i++) {
          let kw = valuesKW[i];
          tableHTML += `<tr><td>${labels[i]}</td><td>${kw}</td></tr>`;
        }
        tableHTML += `</table>`;
        document.getElementById("table-container").innerHTML = tableHTML;
      }

      let ctx = document.getElementById("Courbes").getContext("2d");
      let Courbes = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Puissance moteur (ch)",
              data: values,
              backgroundColor: "rgba(255,0,0,0.2)",
              borderColor: "rgba(255,0,0,1)",
              borderWidth: 2,
              yAxisID: "y",
            },
            {
              label: "Puissance moteur (kW)",
              data: valuesKW,
              backgroundColor: "rgba(0,255,0,0.2)",
              borderColor: "rgba(0,255,0,1)",
              borderWidth: 2,
              yAxisID: "y1",
            },
          ],
        },
        options: {
          responsive: true,
          interaction: {
            mode: "index",
            intersect: false,
          },
          plugins: {
            tooltip: {
              mode: "index",
              intersect: false,
            },
          },
          scales: {
            x: {
              beginAtZero: true,
              title: {
                display: true,
                text: "Régime moteur (tr/min)",
              },
            },
            y: {
              beginAtZero: true,
              position: "left",
              title: {
                display: true,
                text: "Puissance (ch)",
              },
            },
            y1: {
              beginAtZero: true,
              position: "right",
              title: {
                display: true,
                text: "Puissance (kW)",
              },
              grid: {
                drawOnChartArea: false,
              },
              ticks: {
                callback: function (value) {
                  return (value * 0.7355).toFixed(0);
                },
              },
            },
          },
        },
      });

      createSliders();
      createTable();

      function copyTable() {
        let output = "";
        for (let i = 0; i < labels.length; i++) {
          output += `${labels[i]} | ${valuesKW[i]}\n`;
        }

        navigator.clipboard
          .writeText(output)
          .then(() => alert("Tableau copié dans le presse-papiers !"))
          .catch((err) => alert("Erreur lors de la copie : " + err));
      }

      function scrollToSlider(input) {
        const filter = input.trim();
        if (filter === "") {
          createSliders(); // Affiche tout si vide
          return;
        }

        createSliders(filter);

        // Animation douce vers le premier résultat
        const firstMatch = document.querySelector(".slider-group");
        if (firstMatch) {
          firstMatch.scrollIntoView({ behavior: "smooth", block: "center" });
          firstMatch.style.boxShadow = "0 0 10px 3px #3b82f6";
          setTimeout(() => (firstMatch.style.boxShadow = ""), 1000);
        }
      }
    </script>
  </body>
</html>
